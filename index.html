<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Siren Run Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; background:#000; overflow:hidden; }
    canvas { display:block; margin:0 auto; background:#222; touch-action:manipulation; }
    #overlay {
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.7); color:#fff; font-family:sans-serif;
      font-size:22px; z-index:10; text-align:center; flex-direction:column;
    }
    #overlay h1 { margin:0 0 12px 0; font-size:28px; }
    #overlay p { margin:6px 0; }
    #overlay button {
      padding:16px 28px; font-size:22px; margin-top:16px;
      width:80%; max-width:320px; cursor:pointer;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="overlay">
    <h1>Siren Run</h1>
    <p>Press Space or Tap to start</p>
    <button id="startBtn">Start</button>
  </div>

  <script>
/* -------- Setup -------- */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const startBtn = document.getElementById("startBtn");

/* Match your ground image height here */
const GROUND_HEIGHT = 120; // adjust if your ground art is taller/shorter
let groundY = 0;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = Math.max(320, Math.floor(window.innerHeight * 0.6));
  groundY = canvas.height - GROUND_HEIGHT;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

/* -------- Assets -------- */
const img = {
  player: new Image(),
  siren: new Image(),
  obstacle: new Image(),
  coin: new Image(),
  bgFar: new Image(),
  bgMid: new Image(),
  ground: new Image(),
  sky: new Image()
};

img.player.src   = "player.png";
img.siren.src    = "siren.png";
img.obstacle.src = "obstacle.png";
img.coin.src     = "coin.png";
img.bgFar.src    = "bg_far.png";
img.bgMid.src    = "bg_mid.png";
img.ground.src   = "ground.png";
img.sky.src      = "sky.png";

function safeAudio(src) {
  try { return new Audio(src); }
  catch { return { play:()=>Promise.resolve(), pause:()=>{}, loop:false }; }
}

const sfx = {
  jump: safeAudio("jump.mp3"),
  coin: safeAudio("coin.mp3"),
  sirenSong: safeAudio("siren_song.mp3"),
};

/* -------- Game State -------- */
let gameRunning = false;
let score = 0;
let obstacleHits = 0;

let player = { x:150, y:0, vy:0, width:50, height:50 };
let siren  = { x:-200, y:0, vy:0, width:50, height:50 };

let obstacles = [];
let coins = [];

const gravity = 0.6;
const baseSpeed = 5;
let speed = baseSpeed;
const speedIncrease = 0.0005;

/* Siren warning */
let sirenActive = false;
let warningFlash = 0;
let sirenTimer = 0; // frames

/* -------- Controls -------- */
function startGame() {
  overlay.style.display = "none";
  gameRunning = true;

  score = 0;
  obstacleHits = 0;

  obstacles = [];
  coins = [];

  speed = baseSpeed;

  player.x = 150;
  player.y = groundY - player.height;
  player.vy = 0;

  siren.x = -200;
  siren.y = groundY - siren.height;
  siren.vy = 0;

  sirenActive = false;
  warningFlash = 0;
  sirenTimer = 0;

  sfx.sirenSong.loop = true;
  if (sfx.sirenSong.play) sfx.sirenSong.play().catch(()=>{});

  requestAnimationFrame(update);
}

function restartGame() {
  startGame();
}

function jump() {
  if (player.y >= groundY - player.height) {
    player.vy = -10;
    if (sfx.jump.play) sfx.jump.play().catch(()=>{});
  }
}

document.addEventListener("keydown", e => {
  if (e.code === "Space") { if (!gameRunning) startGame(); else jump(); }
});
canvas.addEventListener("click", () => { if (!gameRunning) startGame(); else jump(); });
canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  if (!gameRunning) startGame(); else jump();
});
startBtn.addEventListener("click", startGame);

/* -------- Spawning -------- */
function spawnObstacle() {
  if (Math.random() < 0.05) {
    const lastX = obstacles.length > 0 ? obstacles[obstacles.length - 1].x : 0;
    if (obstacles.length === 0 || lastX < canvas.width - (40 * 5)) {
      const count = Math.random() < 0.3 ? 2 : 1;
      for (let i = 0; i < count; i++) {
        obstacles.push({
          x: canvas.width + i * 30,
          y: groundY - 40, // obstacle sits on ground
          width: 40,
          height: 40,
          hit: false
        });
      }
    }
  }
}

function spawnCoin() {
  if (Math.random() < 0.02) {
    coins.push({
      x: canvas.width,
      y: groundY - 100, // 100px above ground
      width: 30,
      height: 30
    });
  }
}

/* -------- Loop -------- */
function update() {
  if (!gameRunning) return;

  speed += speedIncrease;

  // Physics
  player.vy += gravity;
  player.y += player.vy;
  if (player.y > groundY - player.height) {
    player.y = groundY - player.height;
    player.vy = 0;
  }

  siren.vy += gravity;
  siren.y += siren.vy;
  if (siren.y > groundY - siren.height) {
    siren.y = groundY - siren.height;
    siren.vy = 0;
  }

  // Spawns
  spawnObstacle();
  spawnCoin();

  // Movement
  obstacles.forEach(o => o.x -= speed);
  coins.forEach(c => c.x -= speed);

  // Collisions with obstacles
  obstacles.forEach(o => {
    if (!o.hit &&
        player.x < o.x + o.width - 10 &&
        player.x + player.width - 10 > o.x + 10 &&
        player.y < o.y + o.height - 10 &&
        player.y + player.height - 10 > o.y + 10) {
      o.hit = true;
      obstacleHits++;

      if (!sirenActive) {
        sirenActive = true;
        siren.x = player.x - 250;
        warningFlash = 30;
        sirenTimer = 600; // ~10 seconds at 60fps
      } else {
        gameOver();
      }
    }
  });

  // Coin collection + cleanup
  coins = coins.filter(c => {
    const hit =
      player.x < c.x + c.width &&
      player.x + player.width > c.x &&
      player.y < c.y + c.height &&
      player.y + player.height > c.y;
    if (hit) {
      score++;
      if (sfx.coin.play) sfx.coin.play().catch(()=>{});
      return false;
    }
    // keep on screen
    return c.x + c.width > 0;
  });

  obstacles = obstacles.filter(o => o.x + o.width > 0);

  // Siren behavior
  if (sirenActive) {
    if (sirenTimer > 0) {
      sirenTimer--;
      // approach but maintain gap
      if (siren.x < player.x - 100) {
        siren.x += 2;
      }
    } else {
      // retreat after timer
      siren.x -= 3;
      if (siren.x < -200) {
        sirenActive = false;
        siren.x = -200;
        obstacleHits = 0;
      }
    }
  }

  draw();
  requestAnimationFrame(update);
}

/* -------- Render -------- */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Background
  ctx.drawImage(img.bgFar, 0, 0, canvas.width, canvas.height);
  ctx.drawImage(img.bgMid, 0, 0, canvas.width, canvas.height);
  ctx.drawImage(img.sky,   0, 0, canvas.width, canvas.height);

  // Ground (matches GROUND_HEIGHT)
  ctx.drawImage(img.ground, 0, groundY, canvas.width, GROUND_HEIGHT);

  // Entities
  ctx.drawImage(img.player, player.x, player.y, player.width, player.height);
  ctx.drawImage(img.siren,  siren.x,  siren.y,  siren.width,  siren.height);
  obstacles.forEach(o => ctx.drawImage(img.obstacle, o.x, o.y, o.width, o.height));
  coins.forEach(c => ctx.drawImage(img.coin, c.x, c.y, c.width, c.height));

  // HUD
  ctx.fillStyle = "white";
  ctx.font = "20px Arial";
  ctx.fillText("Score: " + score, 10, 30);
  ctx.fillText("Hits: " + obstacleHits, 10, 60);
  ctx.fillText("Speed: " + speed.toFixed(2), 10, 90);

  // Siren warning flash overlay
  if (sirenActive && warningFlash > 0) {
    ctx.fillStyle = `rgba(255,0,0,${warningFlash / 30})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    warningFlash--;
  }

  // Siren timer bar (below HUD)
  if (sirenActive && sirenTimer > 0) {
    const barWidth = (sirenTimer / 600) * canvas.width;
    ctx.fillStyle = "red";
    ctx.fillRect(0, 110, barWidth, 10);
  }
}

/* -------- Game Over -------- */
function gameOver() {
  gameRunning = false;
  if (sfx.sirenSong.pause) sfx.sirenSong.pause();

  overlay.style.display = "flex";
  overlay.innerHTML = `
    <h1>Game Over</h1>
    <p>Score: ${score}</p>
    <button id="restartBtn">Restart</button>
  `;
  const restartBtn = document.getElementById("restartBtn");
  restartBtn.addEventListener("click", restartGame, { once: true });
}
  </script>
</body>
</html>
